<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>练习</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body class="bg-light">
  <nav class="navbar navbar-white bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand">刷题系统</a>
      <div><a class="btn btn-link" href="/dashboard">返回面板</a></div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row g-3">
      <div class="col-lg-8">
        <div id="card" class="card shadow-sm">
          <div class="card-body">
            <!-- 题目头部（左：多行标题；右：星标）-->
            <div class="d-flex q-header">
              <h5 id="qtitle">加载中...</h5>
              <div class="star-wrap">
                <button id="starBtn" class="btn btn-outline-secondary btn-sm">☆</button>
              </div>
            </div>

            <div id="opts" class="mt-3"></div>

            <!-- 底部控制行：单行显示 左侧提交+反馈，右侧上一/下一题 -->
            <div class="mt-3 d-flex align-items-center justify-content-between gap-2">
              <div class="d-flex align-items-center gap-2">
                <button id="submitBtn" class="btn btn-primary btn-sm" style="display:none;">提交</button>
                <div id="feedback" class="fw-bold"></div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button id="prevBtn" class="btn btn-light btn-sm">上一题</button>
                <button id="nextBtn" class="btn btn-primary btn-sm">下一题</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>题目列表</h6>
            <div id="list" class="uid-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/app.js"></script>
  <script>
let currentList = [];
let currentPos = 0;
let currentKey = null;
let revealMode = false;
let showExplanations = false;

async function loadFlags() {
  const res = await fetch('/api/flags');
  if (res.ok) {
    const f = await res.json();
    revealMode = !!f.reveal_mode;
    showExplanations = !!f.show_explanations;
  }
}

async function startPractice(mode, options = {}) {
  if (mode === 'random' || mode === 'wrong' || mode === 'star') {
    currentPos = 0;
    displayQuestion(0);
  } else {
    displayQuestion(currentPos);
  }
}

async function displayQuestion(index) {
  if (index >= currentList.length) {
    alert("题目已完成");
    return;
  }
  
  currentPos = index;
  const uid = currentList[index];
  const course = "{{ course }}";
  
  const revealParam = revealMode ? 1 : 0;
  const res = await fetch(`/api/question?uid=${uid}&reveal=${revealParam}&course=${course}`);
  
  if (!res.ok) {
    alert("题目加载失败");
    return;
  }
  
  const q = await res.json();
  
  let html = `<h4>${q.question}</h4>`;
  html += `<div class="options">`;
  
  for (const [key, val] of Object.entries(q.options || {})) {
    html += `<button onclick="submitAnswer('${uid}', '${key}')">${key}. ${val}</button>`;
  }
  
  html += `</div>`;
  
  if (revealMode) {
    html += `<div class="answer-reveal"><strong>答案：${q.answer}</strong></div>`;
    if (showExplanations && q.explanation) {
      html += `<div class="explanation"><strong>解析：</strong>${q.explanation}</div>`;
    }
  }
  
  document.getElementById("quiz-content").innerHTML = html;
}

async function submitAnswer(uid, selected) {
  const course = "{{ course }}";
  const res = await fetch('/api/answer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ uid, selected, course })
  });
  
  if (!res.ok) return;
  
  const result = await res.json();
  const correct = result.correct;
  const answer = result.answer;
  
  let feedback = `<strong>${correct ? '✓ 正确' : '✗ 错误'}</strong><br>`;
  feedback += `答案：${answer}`;
  
  if (!revealMode && showExplanations) {
    const qRes = await fetch(`/api/question?uid=${uid}&reveal=1&course=${course}`);
    if (qRes.ok) {
      const q = await qRes.json();
      if (q.explanation) {
        feedback += `<br><strong>解析：</strong>${q.explanation}`;
      }
    }
  }
  
  const explanationDiv = document.querySelector(".explanation");
  if (explanationDiv) {
    explanationDiv.style.display = showExplanations ? "block" : "none";
  }
  
  alert(feedback);
  nextQuestion();
}

function nextQuestion() {
  if (currentPos + 1 < currentList.length) {
    displayQuestion(currentPos + 1);
  } else {
    alert("本单元题目已完成");
  }
}

window.onload = async () => {
  await loadFlags();
};
</script>
</body>
</html>
