<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>面板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-white bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand">刷题系统</a>
      <div class="d-flex">
        <div class="me-3 text-muted">用户: {{session.user}} {% if user_info %} (uid: {{user_info.uid}}){% endif %}</div>
        <a class="btn btn-outline-secondary btn-sm" href="/logout">登出</a>
      </div>
    </div>
  </nav>
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h5 class="mb-3">题库：{{ '毛概' if course=='maogai' else '马原' }}</h5>
            <div class="list-group">
              {% for u in units %}
                <div class="list-group-item unit-item">
                  <div class="unit-title">{{u}}</div>
                  <div class="unit-actions">
                    <button class="btn btn-sm btn-primary w-100" onclick="startSeq('{{u}}')">开始</button>
                    <button class="btn btn-sm btn-outline-danger w-100 mt-0.5" onclick="clearUnit('{{u}}')">清除</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card mb-3 shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-success" onclick="startRandom(50)">随机刷题</button>
              <button class="btn btn-warning" onclick="startTag('wrong')">错题练习</button>
              <button class="btn btn-info" onclick="startTag('star')">标星练习</button>
            </div>
            <div class="d-flex align-items-center gap-2 justify-content-end">
              <a class="btn btn-outline-primary" href="/quiz">继续刷题</a>
              <button id="revealToggle" class="btn reveal-off" onclick="toggleReveal()">背题模式</button>
              <button id="explainToggle" class="btn reveal-off" onclick="toggleExplain()">显示解析</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
let revealFlag = false;
let explainFlag = false;

async function loadFlags(){
  const res = await fetch('/api/flags');
  if(res.ok){ 
    const f = await res.json(); 
    revealFlag = !!f.reveal_mode;
    explainFlag = !!f.show_explanations;
    setRevealVisual();
    setExplainVisual();
  }
}

function setRevealVisual(){
  const btn=document.getElementById('revealToggle');
  if(!btn) return;
  if(revealFlag){
    btn.classList.add('reveal-on'); btn.classList.remove('reveal-off');
  } else {
    btn.classList.add('reveal-off'); btn.classList.remove('reveal-on');
  }
}

function setExplainVisual(){
  const btn=document.getElementById('explainToggle');
  if(!btn) return;
  if(explainFlag){
    btn.classList.add('reveal-on'); btn.classList.remove('reveal-off');
  } else {
    btn.classList.add('reveal-off'); btn.classList.remove('reveal-on');
  }
}

async function toggleReveal(){
  revealFlag = !revealFlag;
  await fetch('/api/flags',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({reveal_mode: revealFlag})});
  setRevealVisual();
}

async function toggleExplain(){
  explainFlag = !explainFlag;
  await fetch('/api/flags',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({show_explanations: explainFlag})});
  setExplainVisual();
}

function startSeq(u){ fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'sequential',unit:u, reveal: revealFlag})}).then(()=>location='/quiz'); }
function startRandom(count=50){ fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'random',count:count, reveal: revealFlag})}).then(()=>location='/quiz'); }
function startTag(t){ fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'tag',tag:t, reveal: revealFlag})}).then(()=>location='/quiz'); }

async function clearUnit(u){
  if(!confirm('确认清除本单元的做题记录（不清除错题/标星）？')) return;
  const r = await fetch('/api/clear_unit', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({unit:u})});
  if(r.ok){ alert('已清除本单元做题记录'); } else { alert('清除失败'); }
}

async function startSequential(unit){
  const course = "{{ course }}";
  await fetch('/api/start', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({mode: 'sequential', unit: unit, reveal: false, course: course})
  });
  location = '/quiz';
}

window.onload = loadFlags;
</script>
</body>
</html>
